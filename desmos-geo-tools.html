<!DOCTYPE html>
<html>
<head>
    <title>Desmos Dynamic Builder</title>
    <script src="https://www.desmos.com/api/v1.10/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>
    <style>
        body { margin: 0; padding: 0; }
        #calculator { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="calculator"></div>
    <script>
        const elt = document.getElementById('calculator');
        const calculator = Desmos.GraphingCalculator(elt, {
            expressions: true,
            settingsMenu: true,
            projectorMode: false,
            zoomButtons: true,
            expressionsCollapsed: false,
            keypad: true
        });

        const params = new URLSearchParams(window.location.search);
        const config = params.get('config');

        // The base state object we will build upon
        const state = {
            version: 11,
            graph: { degreeMode: false }, // Default to radians
            expressions: { list: [] }
        };

        if (config) {
            const featureMap = {
                slider: (parts) => {
                    const [name, val, min, max, step] = parts;
                    return {
                        type: 'expression',
                        latex: `${name}=${val}`,
                        slider: { min, max, step, hardMin: true, hardMax: true }
                    };
                },
                point: (parts) => {
                    const [name, ...coords] = parts;
                    return {
                        type: 'expression',
                        latex: `${name}=(${coords.join(',')})`,
                        showLabel: true
                    };
                },
                segment: (parts) => {
                    const [p1, p2] = parts;
                    // Note: Use _{} for subscripts with multiple characters
                    return {
                        type: 'expression',
                        latex: `((1-t)${p1}.x+t${p2}.x,(1-t)${p1}.y+t${p2}.y)`,
                        parametricDomain: { min: '0', max: '1' }
                    };
                },
                expression: (parts) => {
                    return { type: 'expression', latex: parts.join(',') };
                }
            };

            const definitions = config.split(';');
            definitions.forEach(def => {
                try {
                    const [feature, paramsStr] = def.split('=');
                    
                    // Handle global settings separately
                    if (feature === 'degree_mode') {
                        state.graph.degreeMode = (paramsStr === 'true');
                        return; // Go to the next definition
                    }
                    
                    const paramsArr = paramsStr.split(',');
                    const handler = featureMap[feature] || featureMap['expression'];
                    const expressionObject = handler(paramsArr);
                    state.expressions.list.push(expressionObject);

                } catch (e) {
                    console.error("Could not parse definition:", def, e);
                }
            });

            calculator.setState(state);
            console.log("Desmos state loaded from config.", state);
        }
    </script>
</body>
</html>
