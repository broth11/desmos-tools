<!DOCTYPE html>
<html>
<head>
    <title>Desmos Dynamic Builder</title>
    <script src="https://www.desmos.com/api/v1.10/calculator.js?apiKey=dcb31709b452b1cf9dc26972add0fda6"></script>
    <style>
        body { margin: 0; padding: 0; }
        #calculator { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="calculator"></div>
    <script>
        const elt = document.getElementById('calculator');
        const calculator = Desmos.GraphingCalculator(elt, {
            expressions: true,
            settingsMenu: true,
            projectorMode: false,
            zoomButtons: true,
            expressionsCollapsed: false,
            keypad: true
        });

        const params = new URLSearchParams(window.location.search);
        const config = params.get('config');

        // The base state object we will build upon
        const state = {
            version: 11,
            expressions: { list: [] }
        };

        if (config) {
            // A map of feature names to the functions that create their state objects
            const featureMap = {
                slider: (parts) => {
                    const [name, val, min, max, step] = parts;
                    return {
                        type: 'expression',
                        latex: `${name}=${val}`,
                        slider: { min, max, step, hardMin: true, hardMax: true }
                    };
                },
                point: (parts) => {
                    const [name, x, y] = parts;
                    return {
                        type: 'expression',
                        latex: `${name}=(${x},${y})`,
                        showLabel: true
                    };
                },
                polygon: (parts) => {
                    const pointNames = parts.join(',');
                    return {
                        type: 'expression',
                        latex: `\\operatorname{polygon}(${pointNames})`,
                        fillOpacity: 0.2
                    };
                },
                // NOTE: A segment in the graphing calculator uses a parametric equation
                segment: (parts) => {
                    const [p1, p2] = parts;
                    return {
                        type: 'expression',
                        latex: `((1-t)${p1}.x+t${p2}.x,(1-t)${p1}.y+t${p2}.y)`,
                        parametricDomain: { min: '0', max: '1' }
                    };
                },
                // For any other standard Desmos expression (lines, circles, etc.)
                expression: (parts) => {
                    const latex = parts.join(','); // Re-join in case of commas in the expression
                    return { type: 'expression', latex: latex };
                }
            };

            const definitions = config.split(';');
            definitions.forEach(def => {
                try {
                    const [feature, paramsStr] = def.split('=');
                    const paramsArr = paramsStr.split(',');
                    
                    let expressionObject;
                    if (featureMap[feature]) {
                        expressionObject = featureMap[feature](paramsArr);
                    } else {
                        // Default to a simple expression if feature name is not found
                        expressionObject = featureMap['expression'](paramsArr);
                    }
                    state.expressions.list.push(expressionObject);

                } catch (e) {
                    console.error("Could not parse definition:", def, e);
                }
            });

            calculator.setState(state);
            console.log("Desmos state loaded from config.", state);
        }
    </script>
</body>
</html>
